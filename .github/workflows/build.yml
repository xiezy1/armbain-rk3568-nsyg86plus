name: Build Armbian RK3568

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl build-essential \
            gcc g++ bc bison flex libssl-dev make libc6-dev \
            libncurses5-dev crossbuild-essential-arm64 \
            python3 python3-distutils python3-apt qemu-user-static \
            debootstrap debian-archive-keyring

      - name: Clone Armbian build
        run: |
          git clone --depth=1 https://github.com/armbian/build armbian-build
          cp config/boards/nsy-g68-plus.conf armbian-build/config/boards/
          mkdir -p armbian-build/userpatches
          cp -r userpatches/* armbian-build/userpatches/

      # - name: Copy u-boot defconfig
      #   run: |
      #     cp config/boards/nsy-g68-plus-rk3568_defconfig armbian-build/cache/sources/u-boot/2022.07/configs/
      - name: Replace u-boot with Kwiboo version
        run: |
          # 清理旧的 U-Boot 源码。
          # rm -rf armbian-build/cache/sources/u-boot/v2022.07
    
          # 克隆自定义的 U-Boot 仓库。
          # git clone --depth=1 https://github.com/Kwiboo/u-boot-rockchip armbian-build/cache/sources/u-boot/2022.07
          
          # 💥 新增步骤：创建 configs 文件夹。
          # mkdir -p armbian-build/cache/sources/u-boot/v2022.07/configs/
          
          # 现在，将配置文件复制到新创建的目录中。
          cp config/boards/nsy-g68-plus-rk3568_defconfig armbian-build/cache/sources/u-boot/v2022.07/configs/
          
          # 调试步骤：再次检查目标目录，确认文件已成功复制。
          ls -l armbian-build/cache/sources/u-boot/v2022.07/configs/
      - name: Build Armbian
        run: |
          cd armbian-build
          ./compile.sh BOARD=nsy-g68-plus BRANCH=current RELEASE=bookworm \
                        BUILD_MINIMAL=no BUILD_DESKTOP=no KERNEL_CONFIGURE=no

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: armbian-build/output/images/*.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}