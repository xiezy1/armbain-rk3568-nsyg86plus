name: Build Armbian RK3568

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl build-essential \
            gcc g++ bc bison flex libssl-dev make libc6-dev \
            libncurses5-dev crossbuild-essential-arm64 \
            python3 python3-distutils python3-apt qemu-user-static \
            debootstrap debian-archive-keyring

      - name: Clone Armbian build scripts
        run: |
          git clone --depth=1 https://github.com/armbian/build.git armbian-build
          cp config/boards/nsy-g68-plus.conf armbian-build/config/boards/
          find build/output/debs/ -type d -name "linux-dtb-*" | while read d; do
              cp ./rk3568-nsy-g68-plus.dtb "$d/boot/dtb/rockchip/"
          done

      - name: Build Armbian
        run: |
          cd armbian-build
          ./compile.sh BOARD=nsy-g68-plus BRANCH=current RELEASE=bookworm \
                        BUILD_MINIMAL=no BUILD_DESKTOP=no KERNEL_CONFIGURE=no

      - name: Upload existing Armbian image
        uses: actions/upload-artifact@v4
        with:
          name: armbian-image
          path: armbian-build/output/images/*.img
