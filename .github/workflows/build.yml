name: Build Armbian RK3568

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl build-essential \
            gcc g++ bc bison flex libssl-dev make libc6-dev \
            libncurses5-dev crossbuild-essential-arm64 \
            python3 python3-distutils python3-apt qemu-user-static \
            debootstrap debian-archive-keyring

      - name: Clone Armbian build scripts
        run: |
          git clone --depth=1 https://github.com/xiezy1/build armbian-build

      - name: Copy custom board config
        run: |
          mkdir -p armbian-build/config/boards
          cp config/boards/nsy-g68-plus.conf armbian-build/config/boards/

      - name: Copy u-boot defconfig and DTS
        run: |
          UB_DIR=armbian-build/cache/sources/u-boot
          mkdir -p $UB_DIR/configs
          mkdir -p $UB_DIR/dts
          cp config/boards/nsy-g68-plus_defconfig $UB_DIR/configs/
          cp userpatches/kernel/rk3568-nsy-g68-plus.dts $UB_DIR/dts/

      # - name: Apply u-boot patches (optional)
      #   run: |
      #     # 如果你有 patch 文件，可以放在 userpatches/u-boot 下
      #     PATCH_DIR=userpatches/u-boot
      #     UB_DIR=armbian-build/cache/sources/u-boot-worktree/u-boot/v2022.07
      #     if [ -d "$PATCH_DIR" ]; then
      #       for f in $PATCH_DIR/*.patch; do
      #         echo "Applying patch $f"
      #         patch -p1 -d $UB_DIR < $f
      #       done
      #     fi
      - name: Prepare U-Boot custom defconfig
        run: |
          UB_DIR=armbian-build/cache/sources/u-boot-worktree/u-boot/v2022.07
          mkdir -p $UB_DIR/arch/arm/configs
          mkdir -p $UB_DIR/arch/arm/dts

          # 确认文件存在
          ls -l config/boards/

          # 复制 defconfig 和 dts
          cp userpatches/kernel/rk3568-nsy-g68-plus.dts $UB_DIR/arch/arm/dts/
          cp config/boards/nsy-g68-plus_defconfig armbian-build/cache/sources/u-boot/v2022.07/configs/
          ls -l armbian-build/cache/sources/u-boot/v2022.07/configs/
          # 再次检查
          ls -l $UB_DIR/configs/
          ls -l $UB_DIR/arch/arm/dts/

      - name: Build Armbian
        run: |
          cd armbian-build
          ./compile.sh BOARD=nsy-g68-plus BRANCH=current RELEASE=bookworm \
                        BUILD_MINIMAL=no BUILD_DESKTOP=no KERNEL_CONFIGURE=no

      - name: Upload built images to release
        uses: softprops/action-gh-release@v1
        with:
          files: armbian-build/output/images/*.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
