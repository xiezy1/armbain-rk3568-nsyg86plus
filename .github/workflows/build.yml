name: Build Armbian RK3568

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl build-essential \
            gcc g++ bc bison flex libssl-dev make libc6-dev \
            libncurses5-dev crossbuild-essential-arm64 \
            python3 python3-distutils python3-apt qemu-user-static \
            debootstrap debian-archive-keyring

      - name: Clone Armbian build
        run: |
          git clone --depth=1 https://github.com/armbian/build armbian-build
          cp config/boards/nsy-g68-plus.conf armbian-build/config/boards/
          mkdir -p armbian-build/userpatches
          cp -r userpatches/* armbian-build/userpatches/

      # - name: Copy u-boot defconfig
      #   run: |
      #     cp config/boards/nsy-g68-plus-rk3568_defconfig armbian-build/cache/sources/u-boot/2022.07/configs/
      - name: Replace u-boot with Kwiboo version
        run: |
          # æ¸…ç†æ—§çš„ U-Boot æºç ã€‚
          # rm -rf armbian-build/cache/sources/u-boot/v2022.07
    
          # å…‹éš†è‡ªå®šä¹‰çš„ U-Boot ä»“åº“ã€‚
          # git clone --depth=1 https://github.com/Kwiboo/u-boot-rockchip armbian-build/cache/sources/u-boot/2022.07
          
          # ğŸ’¥ æ–°å¢æ­¥éª¤ï¼šåˆ›å»º configs æ–‡ä»¶å¤¹ã€‚
          # mkdir -p armbian-build/cache/sources/u-boot/v2022.07/configs/
          
          # ç°åœ¨ï¼Œå°†é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°æ–°åˆ›å»ºçš„ç›®å½•ä¸­ã€‚
          cp config/boards/nsy-g68-plus-rk3568_defconfig armbian-build/cache/sources/u-boot/v2022.07/configs/
          
          # è°ƒè¯•æ­¥éª¤ï¼šå†æ¬¡æ£€æŸ¥ç›®æ ‡ç›®å½•ï¼Œç¡®è®¤æ–‡ä»¶å·²æˆåŠŸå¤åˆ¶ã€‚
          ls -l armbian-build/cache/sources/u-boot/v2022.07/configs/
      - name: Build Armbian
        run: |
          cd armbian-build
          ./compile.sh BOARD=nsy-g68-plus BRANCH=current RELEASE=bookworm \
                        BUILD_MINIMAL=no BUILD_DESKTOP=no KERNEL_CONFIGURE=no

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: armbian-build/output/images/*.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}