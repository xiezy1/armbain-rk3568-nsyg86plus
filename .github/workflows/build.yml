name: Build Armbian RK3568

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl build-essential \
            gcc g++ bc bison flex libssl-dev make libc6-dev \
            libncurses5-dev crossbuild-essential-arm64 \
            python3 python3-distutils python3-apt qemu-user-static \
            debootstrap debian-archive-keyring

      - name: Clone Armbian build
        run: |
          git clone --depth=1 https://github.com/armbian/build armbian-build
          cp config/boards/nsy-g68-plus.conf armbian-build/config/boards/
          mkdir -p armbian-build/userpatches
          cp -r userpatches/* armbian-build/userpatches/

          # 在 Clone Armbian build 之后添加如下步骤
      - name: Replace u-boot with Kwiboo version
        run: |
          rm -rf armbian-build/cache/sources/u-boot/v2023.07
          git clone --depth=1 https://github.com/Kwiboo/u-boot-rockchip armbian-build/cache/sources/u-boot/v2023.07
      - name: Build Armbian
        run: |
          cd armbian-build
          ./compile.sh BOARD=nsy-g68-plus BRANCH=current RELEASE=bookworm \
                        BUILD_MINIMAL=no BUILD_DESKTOP=no KERNEL_CONFIGURE=no

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: armbian-build/output/images/*.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}